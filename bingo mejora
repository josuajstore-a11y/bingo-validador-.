import streamlit as st
import pandas as pd
from openpyxl import load_workbook

# Archivo Excel donde se guardan los datos
EXCEL_FILE = "control_bingo_1000_cartas_validador.xlsx"

# Cargar datos
@st.cache_data
def cargar_datos():
    return pd.read_excel(EXCEL_FILE, sheet_name="Ventas")

# Guardar cambios en el Excel
def guardar_datos(df):
    with pd.ExcelWriter(EXCEL_FILE, engine="openpyxl", mode="w") as writer:
        df.to_excel(writer, sheet_name="Ventas", index=False)

# ===================== INTERFAZ =====================

st.set_page_config(page_title="ğŸ² Validador de Bingo", page_icon="ğŸŸï¸", layout="centered")

# Logo + TÃ­tulo
st.title("ğŸ² Validador y Registro de Cartas de Bingo")
st.markdown("Bienvenido al sistema oficial de control de cartas. AquÃ­ puedes **validar** un cÃ³digo QR o **registrar la venta** de una nueva carta.")

# Cargar base
df = cargar_datos()

# Tabs
tab1, tab2 = st.tabs(["âœ… Validar Carta", "ğŸ›’ Registrar Venta"])

# ===================== VALIDAR CARTA =====================
with tab1:
    st.subheader("Validar cÃ³digo QR / ID de carta")
    codigo = st.text_input("Ingrese el cÃ³digo QR / ID")

    if st.button("Verificar", key="verificar"):
        if codigo in df["ID"].values:
            fila = df[df["ID"] == codigo].iloc[0]
            if fila["Pagado"] == "SI":
                st.success(f"âœ… Carta vÃ¡lida y pagada.\n\nğŸ‘¤ Propietario: {fila['Jugador']}\nğŸ“§ Email: {fila['Email']}")
            else:
                st.warning("âš ï¸ La carta existe pero aÃºn **NO estÃ¡ pagada**.")
        else:
            st.error("âŒ CÃ³digo inexistente en la base de datos.")

# ===================== REGISTRAR VENTA =====================
with tab2:
    st.subheader("Registrar nueva venta")

    with st.form("formulario_venta"):
        id_carta = st.text_input("ID de la carta (ej: BINGO-CARTA-0001)")
        nombre = st.text_input("Nombre del jugador")
        email = st.text_input("Correo del jugador")
        pagado = st.selectbox("Â¿Pagado?", ["NO", "SI"])

        submitted = st.form_submit_button("ğŸ’¾ Guardar")

        if submitted:
            if id_carta in df["ID"].values:
                # Actualizar datos de esa carta
                df.loc[df["ID"] == id_carta, ["Jugador", "Email", "Pagado"]] = [nombre, email, pagado]
                guardar_datos(df)
                st.success(f"âœ… Venta registrada para la carta {id_carta}.")
            else:
                st.error("âŒ El ID no existe en la base de datos.")

